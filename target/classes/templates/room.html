<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <title>Like4Like private room</title>
    <link href="/webjars/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <script src="/webjars/jquery/jquery.min.js"></script>
    <script src="/webjars/sockjs-client/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.1.2/dist/axios.min.js"></script>
    <script src="/webjars/stomp-websocket/stomp.min.js"></script>
    <script th:src="@{/js/app.js}" type="text/javascript"></script>
</head>
<body>
  <p> <span th:text="${username}" id="username" style="visibility: hidden"></span></p>
  <div id="player" class="mb-5"></div> 
  <div id="main-content" class="container d-flex flex-column">
    <div class="row w-100 mb-4">
      <p class="ml-4">Room ID: <span th:text="${roomId}" id="id"></span></p>
    </div>
    <div class="row w-100">
      <div class="col-12 col-lg-6">
        <div class="d-flex justify-content-end flex-column">
        <form class="form-inline">
          <div class="form-group">
            <input type="text" id="search" class="form-control" placeholder="Video ID">
          </div>
          <button id="button_search" class="btn btn-default ml-3">Search</button>
        </form>
        <div>
          <div id="video_container">
  
          </div>
        </div>
        
      </div>
    </div>
        <div class="col-12 col-lg-6">
          <div class="flex-column align-items-end ">
            <form class="form-inline">
                <div class="d-flex justify-content-end">
                  <div class="form-group">
                    <input type="text" id="message" class="form-control" placeholder="Nachricht">
                </div>
                <button id="send" class="btn btn-default ml-3" type="submit">Send</button>
                </div>
            </form>
        
     
        <div>
          <table id="conversation" class="table table-striped">
              <thead>
              <tr>
                  <th>Chat</th>
              </tr>
              </thead>
              <tbody id="greetings">
              </tbody>
          </table>
      </div>
    </div>
  </div>
  </div>
    
</div>
<br><br>
      
      
      <script>
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        function onYouTubeIframeAPIReady() {
          console.log("API bereit");
        }

        function loadSpecVideo(videoUrl) {
          const id = document.getElementById("id").textContent;
          stompClient.send("/send/id="+id, {}, JSON.stringify({"load":videoUrl}))
        }

        var player;

        function ratingSystemReset() {
          likeState = 0;
          const likeLabel = document.getElementById("likeLabel");
          const dislikeLabel = document.getElementById("dislikeLabel");
          likeLabel.textContent = "0";
          dislikeLabel.textContent = "0";
        }

        function ratingSystemSetUp() {
          const id = document.getElementById("id").textContent;
          const playerWrapper = document.getElementById("player");
          
            const likeButton = document.createElement("button");
            likeButton.setAttribute("id", "likeButton");
            likeButton.textContent = "LIKE";

            const dislikeButton = document.createElement("button");
            dislikeButton.setAttribute("id", "dislikeButton");
            dislikeButton.textContent = "DISLIKE";
            
            const likeLabel = document.createElement("label");
            likeLabel.textContent = "0";
            likeLabel.setAttribute("id", "likeLabel");
            
            const dislikeLabel = document.createElement("label");
            dislikeLabel.textContent = "0";
            dislikeLabel.setAttribute("id", "dislikeLabel");
            
            playerWrapper.appendChild(likeButton);
            playerWrapper.appendChild(dislikeButton);
            playerWrapper.appendChild(likeLabel);
            playerWrapper.appendChild(dislikeLabel);

            let likeState = 0;

            dislikeButton.addEventListener("click", () => {
              if(likeState === 0) {
                dislikeLabel.textContent = (Number)(dislikeLabel.textContent) + 1;
                likeState = -1;
              }
              else if(likeState === 1) {
                dislikeLabel.textContent = (Number)(dislikeLabel.textContent) + 1;
                likeLabel.textContent = (Number)(likeLabel.textContent) - 1;
                likeState = -1;
              }
              else {
                dislikeLabel.textContent = (Number)(dislikeLabel.textContent) - 1;
                likeState = 0;
              }
              stompClient.send("/send/id="+id, {}, JSON.stringify({'likeCount': (Number)(likeLabel.textContent), "dislikeCount": (Number)(dislikeLabel.textContent)}))
            });

            likeButton.addEventListener("click", () => {
              if(likeState === 0) {
                likeLabel.textContent = (Number)(likeLabel.textContent) + 1;
                likeState = 1;
              }
              else if(likeState === 1) {
                likeLabel.textContent = (Number)(likeLabel.textContent) - 1;
                likeState = 0;
              }
              else {
                dislikeLabel.textContent = (Number)(dislikeLabel.textContent) - 1;
                likeLabel.textContent = (Number)(likeLabel.textContent) + 1;
                likeState = 1;
              }
              stompClient.send("/send/id="+id, {}, JSON.stringify({'likeCount': (Number)(likeLabel.textContent), "dislikeCount": (Number)(dislikeLabel.textContent)}))
            });
        }

        function onLoadVideo(videoUrl) {
          let loaded = false
          if (player) {
            loaded = true
            document.getElementById("player").remove();
            const newVidDiv = document.createElement("div");
            newVidDiv.setAttribute("id", "player");
            document.body.appendChild(newVidDiv);
          }


          player = new YT.Player('player', {
            height: '390',
            width: '640',
            videoId: videoUrl,
            playerVars: {
              'playsinline': 1
            },
            events: {
              'onStateChange': onPlayerStateChange
            }
          });
          return loaded;
        }

        

  
        var done = false;
      function onPlayerStateChange(event) {
        const id = document.getElementById("id").textContent;
        stompClient.send("/send/id="+id, {}, JSON.stringify({'state': player.getPlayerState(), "timestamp": player.getCurrentTime()}))
      }
      function pauseVideo() {
        player.pauseVideo();
      }

      function startVideo() {
        player.playVideo();
      }

      function updateTimestamp(timestamp) {
        player.seekTo(timestamp, true)
      }

      </script>
      <script th:src="@{/js/sync.js}" type="text/javascript"></script>
      <link href="../static/css/styles.css" th:href="@{/css/styles.css}" rel="stylesheet" />
</body>
</html>